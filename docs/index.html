<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invoke Assistant</title>
  <style>
    body {
      background-color: #111;
      color: #eee;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: row;
      height: 100vh;
    }
    #sidebar {
      width: 60px;
      background-color: #1a1a1a;
      padding: 5px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow-y: auto;
      align-items: center;
    }
    #main {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
    }
    button.function-btn {
      width: 100%;
      padding: 6px;
      background-color: #333;
      color: #eee;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    #chatBox {
      width: 90%;
      max-width: 500px;
      height: 40px;
      overflow-y: auto;
      background: #222;
      border: 1px solid #444;
      padding: 6px;
      margin-top: 20px;
      font-size: 14px;
    }
    .user-message {
      text-align: right;
      margin: 5px;
      color: #99f;
    }
    .bot-message {
      text-align: left;
      margin: 5px;
      color: #9f9;
    }
    #controls {
      display: flex;
      gap: 10px;
    }
    #userInput {
      width: 70%;
      padding: 8px;
    }
    button {
      padding: 8px 12px;
      cursor: pointer;
    }
    #avatarImage {
      margin-top: 20px;
      width: 800px;
      height: 1000px;
      background-color: #333;
      border-radius: 50%;
      box-shadow: 0 0 15px #0ff;
      object-fit: cover;
    }
    .alive {
      box-shadow: 0 0 20px #0f0;
    }
    .pulse {
      animation: pulse 1s ease-in-out;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 20px #0f0; }
      50% { box-shadow: 0 0 40px #0ff; }
      100% { box-shadow: 0 0 20px #0f0; }
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="sidebar">
    <button class="function-btn" onclick="document.getElementById('functionPanel').classList.toggle('hidden')">‚öôÔ∏è</button>
    <div id="functionPanel" class="hidden" style="margin-top: 10px; flex-direction: column; gap: 8px;">
      <!-- Function buttons omitted for brevity -->
    </div>
  </div>

  <div id="main">
    <img id="avatarImage" src="cartoon persona.png" alt="Avatar">
    <div id="chatBox"></div>
    <button id="expandChatBtn" style="font-size: 10px; padding: 2px 6px; margin-top: 4px;">üîç</button>
    <div id="controls">
      <input type="text" id="userInput" placeholder="Say something...">
      <button id="sendBtn">Send</button>
      <button id="speakBtn">üé§</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="memery.js"></script>
  <script>
    const expandBtn = document.getElementById('expandChatBtn');
    const chatBox = document.getElementById('chatBox');
    const sendBtn = document.getElementById('sendBtn');
    const speakBtn = document.getElementById('speakBtn');
    const inputField = document.getElementById('userInput');

    function addMessage(sender, message) {
      const msgDiv = document.createElement("div");
      msgDiv.className = sender === "user" ? "user-message" : "bot-message";
      msgDiv.innerText = message;
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function speakText(text) {
      const synth = window.speechSynthesis;
      if (!synth) return;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "en-US";
      synth.speak(utterance);
    }

    async function fetchResponse(input) {
      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${localStorage.getItem('invoke_api_key') || 'YOUR_API_KEY'}`
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [{ role: "user", content: input }]
        })
      });
      const data = await res.json();
      if (!res.ok) {
        console.error("OpenAI API error:", data);
        return "API error: " + (data.error?.message || "Unknown error");
      }
      return data.choices?.[0]?.message?.content || "No response.";
    }

    sendBtn.addEventListener("click", async () => {
      const input = inputField.value;
      if (!input) return;
      addMessage("user", input);
      inputField.value = "";
      const reply = await fetchResponse(input);
      addMessage("bot", reply);
      speakText(reply);
    });

    try {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = "en-US";

      speakBtn.addEventListener("click", () => recognition.start());

      recognition.onresult = async (event) => {
        const transcript = event.results[0][0].transcript;
        addMessage("user", transcript);
        const reply = await fetchResponse(transcript);
        addMessage("bot", reply);
        speakText(reply);
      };
    } catch (e) {
      speakBtn.style.display = "none";
    }

    expandBtn.addEventListener('click', () => {
      if (chatBox.classList.contains('expanded')) {
        chatBox.classList.remove('expanded');
        chatBox.style.height = '40px';
        expandBtn.textContent = 'üîç';
      } else {
        chatBox.classList.add('expanded');
        chatBox.style.height = '300px';
        expandBtn.textContent = '‚Ü©Ô∏è';
      }
    });
  </script>
</body>
</html>
